#!/usr/bin/env node

/**
 * Test script for DuckCode IDE OAuth authentication flow
 * This simulates the complete OAuth flow from IDE login to token exchange
 */

const crypto = require('crypto');

// Configuration
const BACKEND_URL = 'http://localhost:3001';
const FRONTEND_URL = 'http://localhost:5174';

// Simulate IDE OAuth flow
async function testOAuthFlow() {
    console.log('üöÄ Testing DuckCode IDE OAuth Authentication Flow\n');

    try {
        // Step 1: Generate state and redirect URI (like the IDE would)
        const state = crypto.randomBytes(16).toString('hex');
        const redirectUri = 'vscode://duckcode.duck-code/auth/callback';
        
        console.log('üì± Step 1: IDE initiates OAuth flow');
        console.log(`   State: ${state}`);
        console.log(`   Redirect URI: ${redirectUri}`);

        // Step 2: Build authorization URL (like the IDE would)
        const authParams = new URLSearchParams({
            state,
            redirect_uri: redirectUri
        });
        
        const authUrl = `${BACKEND_URL}/api/auth/ide/login?${authParams.toString()}`;
        console.log(`\nüåê Step 2: IDE login URL generated`);
        console.log(`   URL: ${authUrl}`);
        console.log(`   ‚ö†Ô∏è  This redirects to login page with IDE parameters`);

        // Step 3: Simulate successful authentication and code generation
        // In real flow, user would login via browser, then backend generates code
        console.log(`\nüîê Step 3: Simulating successful user authentication...`);
        console.log(`   ‚ö†Ô∏è  In real flow:`);
        console.log(`   1. User clicks login in IDE`);
        console.log(`   2. Browser opens with authorization URL`);
        console.log(`   3. User logs in via web interface`);
        console.log(`   4. Backend generates authorization code`);
        console.log(`   5. Backend redirects to IDE with code + state`);

        // Step 4: Simulate authorization code (normally generated by backend)
        const authCode = crypto.randomBytes(32).toString('hex');
        console.log(`\nüìã Step 4: Authorization code generated (simulated)`);
        console.log(`   Code: ${authCode}`);

        // Step 5: Test token exchange endpoint
        console.log(`\nüîÑ Step 5: Testing token exchange endpoint`);
        
        const tokenResponse = await fetch(`${BACKEND_URL}/api/auth/ide/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                code: authCode,
                state: state
            })
        });

        console.log(`   Token exchange status: ${tokenResponse.status}`);
        
        if (tokenResponse.ok) {
            const tokenData = await tokenResponse.json();
            console.log(`   ‚úÖ Token exchange successful!`);
            console.log(`   Access token: ${tokenData.access_token ? 'present' : 'missing'}`);
            console.log(`   User info: ${tokenData.user ? 'present' : 'missing'}`);
        } else {
            const errorData = await tokenResponse.text();
            console.log(`   ‚ùå Token exchange failed: ${errorData}`);
        }

        // Step 6: Test the complete flow URLs
        console.log(`\nüß™ Step 6: Testing complete flow URLs`);
        
        const loginUrl = `${FRONTEND_URL}/login?state=${encodeURIComponent(state)}&redirect_uri=${encodeURIComponent(redirectUri)}`;
        console.log(`   Login URL: ${loginUrl}`);
        console.log(`   üìù To test manually:`);
        console.log(`   1. Open the login URL above in browser`);
        console.log(`   2. Login with valid credentials`);
        console.log(`   3. Should redirect to authorization endpoint`);
        console.log(`   4. Should generate code and redirect to IDE`);

        console.log(`\n‚ú® OAuth flow test completed!`);

    } catch (error) {
        console.error('‚ùå Test failed:', error.message);
        process.exit(1);
    }
}

// Run the test
testOAuthFlow();
